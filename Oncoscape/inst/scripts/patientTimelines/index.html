




<!DOCTYPE html> 
<html>

<head>
   <meta charset="UTF-8">
   <title> OncoDev 1.4</title>

   <script src="http://code.jquery.com/qunit/qunit-1.18.0.js"></script>
   <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.18.0.css">

   <script src="http://oncoscape.sttrcancer.org/oncoscape/js/jquery-2.1.3.min.js"></script>
   <!-- script src="http://oncoscape.sttrcancer.org/oncoscape/js/jquery-1.11.2.min.js"></script-->
   <script src="http://oncoscape.sttrcancer.org/oncoscape/js/jquery-ui-1.11.4.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.7/themes/smoothness/jquery-ui.css">

   <!-- script src="http://oncoscape.sttrcancer.org/oncoscape/js/cytoscape-2.3.10.min.js"></script -->
   <script src="http://oncoscape.sttrcancer.org/oncoscape/js/cytoscape-2.4.4.min.js"></script>

   <script src="http://oncoscape.sttrcancer.org/oncoscape/js/jquery.cytoscape.js-panzoom.js"></script>
   <link   href="http://oncoscape.sttrcancer.org/oncoscape/css/jquery.cytoscape.js-panzoom.css" 
           rel="stylesheet" 
           type="text/css">


   <script src="http://oncoscape.sttrcancer.org/oncoscape/js/d3.min.js"></script>

   <script src="http://oncoscape.sttrcancer.org/oncoscape/js/jquery.dataTables-1.10.5.min.js"></script>
   <link   rel="stylesheet" type="text/css"
           href="http://oncoscape.sttrcancer.org/oncoscape/css/jquery.dataTables-1.10.5.min.css">

   <script src="http://cdn.datatables.net/colvis/1.1.0/js/dataTable.colVis.js"></script>

   <link   rel="stylesheet" type="text/css"
           href="http://cdn.datatables.net/colvis/1.1.0/css/dataTables.colVis.css">

   <script src="http://oncoscape.sttrcancer.org/oncoscape/js/jquery.multi-select.js" type="text/javascript"></script>
   <link href="http://oncoscape.sttrcancer.org/oncoscape/css/multi-select.css" media="screen" rel="stylesheet" type="text/css">
   <script src="http://oncoscape.sttrcancer.org/oncoscape/js/chosen.jquery.min.js" type="text/javascript"></script>
   <link href="http://oncoscape.sttrcancer.org/oncoscape/css/chosen.min.css" media="screen" rel="stylesheet" type="text/css">


<script> 
//--------------------------------------------------------------------------------------------------
// hooks for google analytics

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
  ga('create', 'UA-528883-29', 'auto');
  ga('send', 'pageview');
//--------------------------------------------------------------------------------------------------
</script> 

</head>

<style>

.flex-container {
  display: -webkit-flex;
  display: flex;
  }

.ui-slider-range {
   background-image: none;
   background: lightgrey;
   }

th,td {
   font-size:12px;
   }

.patientDataFilterSliderReadout{
   font-size: 10px;
   height:16px;
   }

.ui-tabs .ui-tabs-nav li a{
   font-size:10pt !important;
   }

.ui-button .ui-button-text{
   font-size:10pt !important;
   }


</style>



<script>
//----------------------------------------------------------------------------------------------------
// These javascript functions and variables are arranged into a simple module so that
// implementation details are kept private from the public API other oncoscape 
// browser modules will use.  common services and utility functions are provided here
//----------------------------------------------------------------------------------------------------
var HubModule = (function () {

  var name = "HubModule";
     // keys are module names, their outermost divs are the values.
     // providing these outermost divs allows was inspired by 
     // the need to allow raising of tabs by the sending tab.
     // TODO: not sure that's still needed

  var selectionDestinations = {};
  var dispatchOptions = {};
  var socketIsConnected = false;
  var socketConnectedFunctions = [];
  var onDocumentReadyFunctions = [];
  var socketURI = window.location.href.replace("http://", "ws://");
  var socket;

  var  messagingRestrictedToLogin = false;

  var modules = {};
//----------------------------------------------------------------------------------------------------
function registerModule(name, moduleObject)
{
   modules[name] = moduleObject;

} // registerModule
//----------------------------------------------------------------------------------------------------
function getModules()
{
   return modules;

} // getModules
//----------------------------------------------------------------------------------------------------
// TODO: add 3rd argument: acceptsIncomingMessages
//       datasets, for instance, seems to have no need for incoming json/websocket messages
function registerSelectionDestination(names, outermostDivID)
{
  if(typeof(names) == "string")
    names = [names];

  for(var i=0; i < names.length; i++)
     selectionDestinations[names[i]] = outermostDivID;

} // registerSelectionDestination
//----------------------------------------------------------------------------------------------------
function getRegisteredSelectionDestinations()
{
  return(selectionDestinations);

} // getRegisteredSelectionDestinations
//----------------------------------------------------------------------------------------------------
function setupSocket(socket)
{
  console.log("=== Module.hub setupSocket");

  try {
     socket.onopen = function() {
        console.log("websocket connection now open");
        socketIsConnected = true;
        for(var f=0; f < socketConnectedFunctions.length; f++){
           console.log("calling the next sockectConnectedFunction");
           socketConnectedFunctions[f]();
           } // for f
        } // socked.onopen

     socket.onmessage = function got_packet(msg) {
        //console.log("=== Hub, socket.onmessage");
        var msg = JSON.parse(msg.data)
        dispatchMessage(msg)
        } // socket.onmessage, got_packet

     socket.onclose = function(){
        console.log("socket closing");
        } // socket.onclose
     } // try
  catch(exception) {
    console.log("Error: " + exception);
    }
 
  return(socket);

} // setupSocket
//----------------------------------------------------------------------------------------------------
function socketConnected()
{
   return(socketIsConnected);

} // socketConnected
//----------------------------------------------------------------------------------------------------
function addSocketConnectedFunction(func)
{
   socketConnectedFunctions.push(func)

} // addSocketConnectedFunction
//----------------------------------------------------------------------------------------------------
function getSocketConnectedFunctions()
{
   return(socketConnectedFunctions)

} // getSocketConnectedFunction
//----------------------------------------------------------------------------------------------------
function addOnDocumentReadyFunction(func)
{
   onDocumentReadyFunctions.push(func)

} // addOnDocumentReadyFunction
//----------------------------------------------------------------------------------------------------
function getOnDocumentReadyFunctions()
{
   return(onDocumentReadyFunctions)

} // getOnDocumentReadyFunctions
//----------------------------------------------------------------------------------------------------
// the nginx proxy server, used by fhcrc IT for the publicly-visible version of Oncoscape
// times out web sockets at 90 seconds.
// this function, when called more often that that, will keep the websocket open.
keepAlive = function()
{   
    //console.log("keep alive"); 
    msg = {cmd: "keepAlive", callback: "", status:"request", payload:""}
    socket.send(JSON.stringify(msg));

} // keepAlive
//--------------------------------------------------------------------------------------------------
function runOnDocumentReadyFunctions()
{
  setInterval(keepAlive, 30000);
  var funcs = getOnDocumentReadyFunctions()
  console.log("==== Module.hub: " + funcs.length + " onDocumentReadyFunctions");

  for (var f = 0; f < funcs.length; f++) {
     console.log("calling on ready function");
     funcs[f]();
     }

} // runOnDocumentReadyFunctions
//----------------------------------------------------------------------------------------------------
function runningInNode()
{
    // a not very sophisticated test, but adequate for our purposes thus far
  return(typeof(window) == "undefined")

} // functionRunningInNode
//----------------------------------------------------------------------------------------------------
function initializeWebSocket()
{
   if(runningInNode()){
     console.log("--- web socket not currently available when runing in Node");
     process.exit(code=1)
     }

   socket = new WebSocket(socketURI);
   socket = setupSocket(socket);

} // initializeWebSocket
//----------------------------------------------------------------------------------------------------
function getSocket()
{
  return(socket);

} // getSocket
//----------------------------------------------------------------------------------------------------
function addMessageHandler(cmd, func)
{
  if(cmd in dispatchOptions){
     dispatchOptions[cmd].push(func)
     }
  else{
     dispatchOptions[cmd] = [func]
     }
  
} // addMessageHandler
//----------------------------------------------------------------------------------------------------
function getRegisteredMessageNames()
{
   return(Object.keys(dispatchOptions));
  
} // getRegisteredMessageNames
//----------------------------------------------------------------------------------------------------
function getDispatchOptions()
{
   return(dispatchOptions);
  
} // getDispatchOptions
//----------------------------------------------------------------------------------------------------
function dispatchMessage(msg)
{
   var cmd = msg.cmd;
   var status = msg.status;
   //console.log("=============== dispatching '" + cmd + "'");

   var dispatchKeys = Object.keys(dispatchOptions);
   var cmdIndex = dispatchKeys.indexOf(cmd);
   console.log("hub.dispatchMessage(" + cmd + "): " + cmdIndex);

   if(cmdIndex === -1){
      console.log("unrecognized socket request: " + msg.cmd);
      console.log(" --- msg:");
      console.log(msg);
      console.log(" --- dispatchOptions");
      console.log(dispatchOptions);
      }
   else{
     var funcs = dispatchOptions[cmd];
     //console.log(" func count for msg cmd " + cmd + ": " + funcs.length);
      for(var i=0; i < funcs.length; i++){
         //console.log("--- Module.hub executing func # " + i + " for cmd " + msg.cmd);
         funcs[i](msg); // dispatchOptions[msg.cmd](msg)
         } // for i
      }

}  // dispatchMessage
//----------------------------------------------------------------------------------------------------
function restrictMessagingToLogin(newState)
{
   messagingRestrictedToLogin = newState;

} // restrictMessagingToLogin
//----------------------------------------------------------------------------------------------------
function send(msg)
{
   var cmd = JSON.parse(msg).cmd;
   if(messagingRestrictedToLogin && cmd === "checkPassword"){
      console.log("hub.send drops non-login msg");
      return;
      }

   var browserLocalCommand = Object.keys(dispatchOptions).indexOf(cmd) >= 0;
   var mode = "server";
   if(browserLocalCommand)
      mode = "browser local";

   console.log("--- hub.send: '" + cmd + "' (" + mode + ")");

   if(browserLocalCommand)
      dispatchMessage(JSON.parse(msg));
   else{
      socket.send(msg);
      }

}  // send
//----------------------------------------------------------------------------------------------------
function setTitle (newTitle)
{
  window.document.title = newTitle;

}  // setTitle
//----------------------------------------------------------------------------------------------------
// add a pulldown menu to the specified menuSelector, which has been provided by the caller, which
// is assumed to be an Oncoscape module.  append the names of all previously-registered divs, 
// except for those explicitly excluded in the incoming argument "excludedModules".
// This supports the usual (but not universal) case: a module does not want to send selections
// to itself.
// this argument will often be an array of one element, the name of the calling module.
// some modules may have multiple send destinations (eg, "PCA" & "PCA (highlight)".
function configureSendSelectionMenu(menuSelector, excludedModules, changeFunction, menuTitle)
{
  var menu = $(menuSelector);
  menu.append("<option>" + menuTitle + "</option>");
  menu.change(changeFunction);
  var otherModules = Object.keys(hub.getRegisteredSelectionDestinations());

  for(var i=0; i < otherModules.length; i++){
     var moduleName = otherModules[i];
     var excluded = excludedModules.indexOf(moduleName) >= 0;
     if(!excluded){
        menu.append("<option>" + moduleName + "</option>");
        }
     } // for i

  return(menu);

} // createSendSelectionMenu
//--------------------------------------------------------------------------------------------
function disableButton(button)
{
   button.prop("disabled", true);
   button.css({"background-color": "lightgray", "color": "gray"});

} // disableButton
//--------------------------------------------------------------------------------------------
function enableButton(button)
{
   button.prop("disabled", false);
   //button.css({ 'color': 'black'})
   button.css({"background-color": "white", "color": "black"});

} // enableButton
//--------------------------------------------------------------------------------------------
// if jQuery-style tabs are in use with Oncoscape, this function raised the named tab to the
// the front (visible) position in the tabset
// the argument, "tabIDString" is the tab id used in the module's widget.html, reproduced exactly
// in tabsApp/widget.html, with some current examples being
//  pcaDiv, patientTimeLinesDiv, gbmPathwaysDiv
//
function raiseTab(tabIDString)
{
  var tabsWidget = $("#oncoscapeTabs");

  if(tabsWidget.length > 0){
     var selectionString = '#oncoscapeTabs a[href="#' + tabIDString + '"]';
     var tabIndex = $(selectionString).parent().index ();
     if(tabIndex < 0) throw "Module.hub does not recognize tabIDString '" + tabIDString + "'";
     tabsWidget.tabs( "option", "active", tabIndex);
     } // if tabs exist

} // raiseTab
//----------------------------------------------------------------------------------------------------
// each of our tabs is a div, nested directly within $("oncoscapeTabs").  
// this function returns an array of each of the div ids
function getTabDivIDs()
{
   return ($("#oncoscapeTabs").children("div").map(function(index,dom){return dom.id}));

} // getTabDivIDs
//----------------------------------------------------------------------------------------------------
// e.g., hub.hideTab("Login", "#loginDiv");
function hideTab(tabTitle, tabDivIDstring)
{
  $(".ui-tabs-nav li:contains('" + tabTitle + "')").hide()
  $(tabDivIDstring).hide();

} // hideTab
//----------------------------------------------------------------------------------------------------
function hideAllTabsButOne(tabTitle, tabDivIDstring)
{
  var divIDs = getTabDivIDs();
  
  $(".ui-tabs-nav li:contains('" + tabTitle + "')").hide()
  $(tabDivIDstring).hide();

} // hideAllTabsButOne
//----------------------------------------------------------------------------------------------------
function showTab(tabTitle, tabDivIDstring)
{
  $(".ui-tabs-nav li:contains('" + tabTitle + "')").show()
  $(tabDivIDstring).show();

} // showTab
//----------------------------------------------------------------------------------------------------
function addTab(tabTitle, tabDivIDstring,  content)
{
  var tabs = $("#oncoscapeTabs").tabs()
  var listItem = "<li><a href='#" + tabDivIDstring + "}'>" + tabTitle + "</a>";

  tabs.find(".ui-tabs-nav").append(listItem);
  tabs.append("<div id='" + tabDivIDstring + "'><p>" + content + "</p></div>");
  tabs.tabs("refresh");

} // addTab
//----------------------------------------------------------------------------------------------------
function getRandomFloat (min, max)
{
    return Math.random() * (max - min) + min;
}
//----------------------------------------------------------------------------------------------------
function getRandomInt (min, max) 
{
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
//----------------------------------------------------------------------------------------------------
String.prototype.beginsWith = function (string) 
{
    return(this.toLowerCase().indexOf(string.toLowerCase()) === 0);
};
//----------------------------------------------------------------------------------------------------
uniqueElementsOfArray = function(vector)
{
  var u = {}, a = [];

  for(var i = 0, l = vector.length; i < l; ++i){
     if(u.hasOwnProperty(vector[i])){
       continue;
       }
     a.push(vector[i]);
     u[vector[i]] = 1;
     } // for i

   return a;

} // uniqueElementsOfArray
//----------------------------------------------------------------------------------------------------
// return the targets matched by the candidates, where match is tolerant of differences by suffix
// thus incoming id "TCGA.06.0649.01" matches existing id "TCGA.06.0649" and
//      incoming id "TCGA.06.0649"    matches existing id "TCGA.06.0649.01" 
// this may cause problems with gene names, eg, MYC would mach MYCL and MYCA
// todo: make this suffix-tolerant match suffix-specific 
function intersectionOfArrays(candidates, targets) {

  hits=[]; 

  for(var i=0; i < candidates.length; i++){
    for (var j=0; j < targets.length; j++){
       candidate = candidates[i];
       target = targets[j];
       index1 = candidate.indexOf(target);   // "abc".indexOf("ab") -> 0
       index2 = target.indexOf(candidate); 
       //console.log("c(t): " + candidate + " contains " + target + ": " + index1);
       //console.log("t(c): " + target + " contains " + candidate + ": " + index2);
       if (index1 == 0)
          hits.push(target)
       else if (index2 == 0)
          hits.push(target)
         } // for j
     } // for i

  return(hits)

} // intersectionOfArays
//----------------------------------------------------------------------------------------------------
function setupGlobalExceptionHandler()
{
   window.onerror = function (errorMsg, url, lineNumber, column, errorObj) {

      var title = "Oncoscape Error";
      var options = {buttons: { "Ok": function () { $(this).dialog("close"); } },
                     title: title};
      var text = "<i>" + errorMsg + "</i><br>" +
                 "<br><b>Script</b>: " + url + 
                 "<br><b>Line:</b> " + lineNumber + 
                 "<br><b>Column:</b> " + column + 
                 "<br><b>StackTrace:</b> " +  errorObj;
      $("<div></div>").dialog(options).html(text);
      };
 
} // setupGlobalExceptionHandler
//----------------------------------------------------------------------------------------------------
function start()
{
  setupGlobalExceptionHandler();
  initializeWebSocket();
  $(document).ready(runOnDocumentReadyFunctions);

}  // start
//----------------------------------------------------------------------------------------------------
function test_intersectionOfArrays()
{
   console.log("---  test_intersectionOfArrays");
   var targets = ["TCGA.02.0006"];
   var candidates = ["TCGA.02.0006"];

   QUnit.test("test_intersectionOfArrays 1", function(assert) {
      assert.equal(hub.intersectionOfArrays(candidates, targets), candidates);
      });

   targets = ["TCGA.02.0006"];
   candidates = ["bogus"];
   QUnit.test("test_intersectionOfArrays 2", function(assert) {
      assert.equal(hub.intersectionOfArrays(candidates, targets), []);
      });

   targets = ["bogus"];
   candidates = ["TCGA.02.0006"];
   QUnit.test("test_intersectionOfArrays 3", function(assert) {
      assert.equal(hub.intersectionOfArrays(candidates, targets), []);
      });


   targets = ["TCGA.02.0006.01"];
   candidates = ["TCGA.02.0006"];
   QUnit.test("test_intersectionOfArrays 4", function(assert) {
      assert.equal(hub.intersectionOfArrays(candidates, targets), candidates);
      });

   //targets = ["MAP2"];   this test will fail because sometimes we want incomplete matches:
   //  see test4 just above
   //candidates = ["MAP2K4", "abc"];
   //QUnit.test("test_intersectionOfArrays 5", function(assert) {
   //   assert.equal(hub.intersectionOfArrays(candidates, targets), []);
   //   });


} //  test_intersectionOfArrays
//----------------------------------------------------------------------------------------------------
function standAloneTest()
{
   test_intersectionOfArrays();

}  // standaloneTest
//----------------------------------------------------------------------------------------------------

  return({
     getName: function() {return(name)},
     restrictMessagingToLogin: restrictMessagingToLogin,
     registerModule: registerModule,
     getModules: getModules,
     registerSelectionDestination: registerSelectionDestination,
     getRegisteredSelectionDestinations: getRegisteredSelectionDestinations,
     socketConnected: socketConnected,
     addSocketConnectedFunction: addSocketConnectedFunction,
     getSocketConnectedFunctions: getSocketConnectedFunctions,
     addOnDocumentReadyFunction: addOnDocumentReadyFunction,
     getOnDocumentReadyFunctions: getOnDocumentReadyFunctions,
     runningInNode: runningInNode,
     initializeWebSocket: initializeWebSocket,
     getSocket: getSocket,
     addMessageHandler: addMessageHandler,
     getRegisteredMessageNames: getRegisteredMessageNames,
     getDispatchOptions: getDispatchOptions,
     dispatchMessage: dispatchMessage,
     configureSendSelectionMenu: configureSendSelectionMenu,
     enableButton: enableButton,
     disableButton: disableButton,
     getRandomInt: getRandomInt,
     getRandomFloat: getRandomFloat,
     intersectionOfArrays: intersectionOfArrays,
     uniqueElementsOfArray: uniqueElementsOfArray,
     send: send,
     setTitle: setTitle,
     getTabDivIDs: getTabDivIDs,
     raiseTab: raiseTab,
     hideTab: hideTab,
     showTab: showTab,
     addTab: addTab,
     sat: standAloneTest,
     start: start
     });

}); // HubModule
//----------------------------------------------------------------------------------------------------


var hub = HubModule();
hub.start();

hub.addOnDocumentReadyFunction(function() {
    console.log("====== tabapps document ready");
    window.tabsAppRunning = true
    $("#oncoscapeTabs").tabs({
         // todo: distinguish between tabs, only do needed resets
       activate: function(event, ui) {
            console.log(" tabsApp/code.js:activate");
            var tableRef = $("#historyTable").dataTable();
            var tableRef2 = $("#userDataStoreTable").dataTable();
            if (tableRef.length > 0) {
               console.log("   adjusting patient history table");
               tableRef.fnAdjustColumnSizing();
               } // if
            if (tableRef2.length > 0) {
               console.log("   skipping! - adjusting user data store table");
               tableRef2.fnAdjustColumnSizing();
               } // if
            //console.log(" ==== tab.activate, possible cyjs resize and fit");
            if(typeof(cwMarkers) != "undefined") {
               //console.log("adjusting cwMarkers");
               cwMarkers.resize(); 
               cwMarkers.fit(50);
               //console.log("done adjusting cwMarkers");
               }
            if(typeof(cwGbm) != "undefined") {
               //console.log("adjusting cwGbm");
               cwGbm.resize();
               cwGbm.fit(50);
               //console.log("done adjusting cwGbm");
               }
            if(typeof(cwAngio) != "undefined") {
               //console.log("adjusting cwAngio");
               cwAngio.resize();
               cwAngio.fit(50);
               //console.log("done adjusting cwGbm");
               }
            } // activate
        }); // tabs
    });  // ready



</script>

<style>
.ui-tabs .ui-tabs-nav li a {font-size:10pt !important;}
.ui-button .ui-button-text {font-size:10pt !important;}
</style>

<script>
//----------------------------------------------------------------------------------------------------
var DataSummaryModule = (function () {

  var dataSummaryDiv;

  var outputDiv;
  var dataSetNamesOutputDiv;
  var thisModulesName = "datasets";
  var thisModulesOutermostDiv = "datasetsDiv";

  var tableElement;
  var tableRef;
  var datasetMenu;
  var selectedDataSet;
  var useThisDatasetButton;

  var sendSelectionsMenu;
  var sendSelectionsMenuTitle = "Send selection...";
  var passwordProtected = false;

//----------------------------------------------------------------------------------------------------
function initializeUI()
{
  sendSelectionsMenu = hub.configureSendSelectionMenu("#datasetsSendSelectionsMenu", 
                                                      [thisModulesName], sendSelections,
                                                       sendSelectionsMenuTitle);

  hub.disableButton(sendSelectionsMenu);

  $(window).resize(handleWindowResize);
  datasetMenu = $("#datasetMenu");
  datasetMenu.change(selectManifest);

  dataSetNamesOutputDiv = $("#dataSetNamesOutputDiv");
  dataSummaryDiv = $("#dataSummaryOutputDiv");

  useThisDatasetButton = $("#selectDatasetButton");
  useThisDatasetButton.button();
  hub.disableButton(useThisDatasetButton);
  useThisDatasetButton.click(specifyCurrentDataset);

  outputDiv = $("#dataSummaryOutputDiv");
  tableElement = $("#datasetsManifestTable");
      
    // if no login tab is present, then allow unrestricted choice of datasets.
    // if it IS present, then that tab will control this.

  var loginRequired = $("#loginDiv").length === 1;
  console.log("loginRequired? " + loginRequired);

  if(!loginRequired){
    console.log(" enabling datasetMenu");
    hub.enableButton($("#datasetMenu"));
    }
  else{
    console.log(" disabling datasetMenu");
    hub.disableButton($("#datasetMenu"));
    }

} // initializeUI
//----------------------------------------------------------------------------------------------------
function postStatus(msg)
{
   $("#datasetsStatusDiv").text(msg);

} // postStatus
//----------------------------------------------------------------------------------------------------
function handleWindowResize()
{
  console.log("==== Module.datasets handleWindowResize");

  console.log("  window: " + $(window).width());

  $("#"+thisModulesOutermostDiv).width($(window).width() * 0.95);
  $("#"+thisModulesOutermostDiv).height($(window).height() * 0.95);
//  console.log("  div: " + outputDiv.width());

//  console.log("  tbl before: " + tableElement.width());
//  tableElement.width($(window).width() * 0.50);
//  console.log("  tbl after: " + tableElement.width());

} // handleWindowResize
//----------------------------------------------------------------------------------------------------
function sendSelections(event)
{
   var destination = sendSelectionsMenu.val();
   console.log("send selections to " + destination);
   sendSelectionsMenu.val(sendSelectionsMenuTitle);

   var cmd = "sendSelectionTo_" + destination;
   payload = "dummy payload";
   var newMsg = {cmd: cmd,  callback: "", status: "request", payload: payload};

   sendSelectionsMenu.val(sendSelectionsMenuTitle);

   hub.send(JSON.stringify(newMsg));

} // sendSelections
//----------------------------------------------------------------------------------------------------
function selectManifest(event)
{
   selectedDataSet = datasetMenu.val();
   console.log("dataset '" + selectedDataSet + "'");

   if(selectedDataSet === ""){
     // outputDiv.empty();
      $("#datasetInstructions").css("display", "block")
      $("#datasetsManifestTable").css("display", "none")
      hub.disableButton(useThisDatasetButton);
      }
    else{
      $("#datasetInstructions").css("display", "none")
      $("#datasetsManifestTable").css("display", "block")      
      requestDataSetSummary(selectedDataSet);
    }

} // selectManifest
//----------------------------------------------------------------------------------------------------
function populateDataSetMenu()
{
   $(datasetMenu).ready(function() {
      console.log("=== datasetMenu ready, now issuing populateDataSetMenu request to server");
      var msg = {cmd: "getDataSetNames",  callback: "handleDataSetNames", status: "request", 
                 payload: ""};
      hub.send(JSON.stringify(msg));
      });

} // populateDataSetMenu
//----------------------------------------------------------------------------------------------------
function handleDataSetNames(msg)
{
   console.log("=== handleDataSetNames");
   
   var dataSetNames = msg.payload.datasets;
   var passwordProtected = msg.payload.passwordProtected;

   if(!Array.isArray(dataSetNames))
      dataSetNames = [dataSetNames];

   for(var i=0; i < dataSetNames.length; i++){
      var s = dataSetNames[i];
      datasetMenu.append("<option value='" + s + "'>" + s + "</option>");
      }

  //if(passwordProtected)
  //   hub.disableButton($("#datasetMenu"));


} // handleDataSetNames
//----------------------------------------------------------------------------------------------------
function requestDataSetSummary(dataSetName)
{
   console.log("=== requestDataSetSummary");

   var msg = {cmd: "getDataManifest",  callback: "displayDataManifest", status: "request", 
              payload: dataSetName};

   hub.send(JSON.stringify(msg));

} // requestDataSetSummary
//----------------------------------------------------------------------------------------------------
function displayDataManifest(msg)
{
   var payload = msg.payload;
   var tblColumnNames = payload.colnames;

   var columnTitles = [];
     // convert simple strings to array of objects, each an sTitle
   for(var i=0; i < tblColumnNames.length; i++){
      columnTitles.push({sTitle: tblColumnNames[i]});
      }
     
   if(typeof(tableRef) != "undefined"){
      tableRef.destroy();
      tableElement.empty();
      }


   $(tableElement).ready(function() {
      tableRef = tableElement.DataTable({
        //sDom: 't',
        aoColumns: columnTitles,
        //scrollX: true,
        bPaginate: false,
        bFilter: false, 
        bAutoWidth: true,
        bSort: false,
        bInfo: false
        }); // dataTable

     tableRef = $("#datasetsManifestTable").DataTable();

     tableRef.rows.add(payload.mtx).draw();
     // tableRef.fnAddData(payload.mtx);

     $('#datasetsManifestTable tbody').on( 'click', 'tr', function (){ 
         console.log("=== click");
         var category = $('td', this).eq(0).text();
         var subcategory = $('td', this).eq(1).text();
         if($(this).hasClass("selected")){
            $(this).removeClass('selected');
            hub.disableButton(sendSelectionsMenu);
            }
         else{
            tableRef.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            hub.enableButton(sendSelectionsMenu);
            console.log("selected " + category + ", " + subcategory);
            }
         });

     handleWindowResize();
     hub.enableButton(useThisDatasetButton);
     postStatus("manifest table displayed");
     }); // tableElement.ready

} // displayDataManifest
//----------------------------------------------------------------------------------------------------
function specifyCurrentDataset()
{
   console.log("Module.datasets 'Use Dataset' button clicked, specifyCurrentDataset: " + selectedDataSet);

   var msg = {cmd: "specifyCurrentDataset",  callback: "datasetSpecified", 
              status: "request", payload: selectedDataSet};

   hub.send(JSON.stringify(msg));

} // specifyCurrentDataset
//----------------------------------------------------------------------------------------------------
function datasetSpecified(msg)
{
   console.log("--- Module.datasets:  datasetSpecified");

} // datasetSpecified
//----------------------------------------------------------------------------------------------------
function test(dataSetName)
{
   console.log("Module.datasets test, on datasetName: '" + dataSetName + "'");

   QUnit.test("choose dataset '" + dataSetName + "'", function(assert) {
      hub.raiseTab("datasetsDiv");
      var desiredDataset = dataSetName;
      var dzNames = $("#datasetMenu option").map(function(opt){return this.value})

      if($.inArray(desiredDataset, dzNames) < 0){
         alert("cannot run tests:  " + desiredDataset + " dataset not loaded");
         return;
         }

      $("#datasetMenu").val(desiredDataset)
      $("#datasetMenu").trigger("change");

      var done1 = assert.async();
      var done2 = assert.async();
      var done3 = assert.async();
      assert.expect(3);

      setTimeout(function(){
         assert.equal($("#datasetMenu").val(), desiredDataset);  done1();
         assert.ok($("#datasetsManifestTable tr").length >= 10); done2();
         assert.equal($("#datasetsManifestTable tbody tr").eq(0).find("td").eq(0).text(), 
                      "mRNA expression"); done3();
         //testLoadPatientHistoryTable();
         }, 5000);
      });


} // test
//----------------------------------------------------------------------------------------------------
function moduleInit()
{

  hub.addOnDocumentReadyFunction(initializeUI);
  // hub.addOnDocumentReadyFunction(function() {$("#datasetsDiv").hide();});
  // hub.registerSelectionDestination(thisModulesName, thisModulesOutermostDiv);
  hub.addSocketConnectedFunction(populateDataSetMenu);
  hub.addMessageHandler("handleDataSetNames", handleDataSetNames);
  hub.addMessageHandler("displayDataManifest", displayDataManifest);
  hub.addMessageHandler("datasetSpecified", datasetSpecified);
  hub.setTitle("Datasets");

} // moduleInit
//----------------------------------------------------------------------------------------------------
return{
   init: moduleInit,
   test: test
   }; // DataSummaryModule return value

//----------------------------------------------------------------------------------------------------
}); // DataSummaryModule

var dataSummaryModule = DataSummaryModule();
dataSummaryModule.init();
hub.registerModule("Datasets", dataSummaryModule);

var timelinesXXX;
//----------------------------------------------------------------------------------------------------
var DataSummaryModule = (function () {


  var outputDiv;
  var dataSetNamesOutputDiv;
  var thisModulesName = "datasets";
  var thisModulesOutermostDiv = "datasetsDiv";

  var tableElement;
  var tableRef;
  var datasetMenu;
  var selectedDataSet;
  var useThisDatasetButton;

  var sendSelectionsMenu;
  var sendSelectionsMenuTitle = "Send selection...";
  var passwordProtected = false;

//----------------------------------------------------------------------------------------------------
function initializeUI()
{
  sendSelectionsMenu = hub.configureSendSelectionMenu("#datasetsSendSelectionsMenu", 
                                                      [thisModulesName], sendSelections,
                                                       sendSelectionsMenuTitle);

  hub.disableButton(sendSelectionsMenu);

  $(window).resize(handleWindowResize);
  datasetMenu = $("#datasetMenu");
  datasetMenu.change(selectManifest);

  dataSetNamesOutputDiv = $("#dataSetNamesOutputDiv");
  dataSummaryDiv = $("#dataSummaryOutputDiv");

  useThisDatasetButton = $("#selectDatasetButton");
  useThisDatasetButton.button();
  hub.disableButton(useThisDatasetButton);
  useThisDatasetButton.click(specifyCurrentDataset);

  outputDiv = $("#dataSummaryOutputDiv");
  tableElement = $("#datasetsManifestTable");
      
    // if no login tab is present, then allow unrestricted choice of datasets.
    // if it IS present, then that tab will control this.

  var loginRequired = $("#loginDiv").length === 1;
  console.log("loginRequired? " + loginRequired);

  if(!loginRequired){
    console.log(" enabling datasetMenu");
    hub.enableButton($("#datasetMenu"));
    }
  else{
    console.log(" disabling datasetMenu");
    hub.disableButton($("#datasetMenu"));
    }

} // initializeUI
//----------------------------------------------------------------------------------------------------
function postStatus(msg)
{
   $("#datasetsStatusDiv").text(msg);

} // postStatus
//----------------------------------------------------------------------------------------------------
function handleWindowResize()
{
  console.log("==== Module.datasets handleWindowResize");

  console.log("  window: " + $(window).width());

  $("#"+thisModulesOutermostDiv).width($(window).width() * 0.95);
  $("#"+thisModulesOutermostDiv).height($(window).height() * 0.95);
//  console.log("  div: " + outputDiv.width());

//  console.log("  tbl before: " + tableElement.width());
//  tableElement.width($(window).width() * 0.50);
//  console.log("  tbl after: " + tableElement.width());

} // handleWindowResize
//----------------------------------------------------------------------------------------------------
function sendSelections(event)
{
   var destination = sendSelectionsMenu.val();
   console.log("send selections to " + destination);
   sendSelectionsMenu.val(sendSelectionsMenuTitle);

   var cmd = "sendSelectionTo_" + destination;
   payload = "dummy payload";
   var newMsg = {cmd: cmd,  callback: "", status: "request", payload: payload};

   sendSelectionsMenu.val(sendSelectionsMenuTitle);

   hub.send(JSON.stringify(newMsg));

} // sendSelections
//----------------------------------------------------------------------------------------------------
function selectManifest(event)
{
   selectedDataSet = datasetMenu.val();
   console.log("dataset '" + selectedDataSet + "'");

   if(selectedDataSet === ""){
     // outputDiv.empty();
      $("#datasetInstructions").css("display", "block")
      $("#datasetsManifestTable").css("display", "none")
      hub.disableButton(useThisDatasetButton);
      }
    else{
      $("#datasetInstructions").css("display", "none")
      $("#datasetsManifestTable").css("display", "block")      
      requestDataSetSummary(selectedDataSet);
    }

} // selectManifest
//----------------------------------------------------------------------------------------------------
function populateDataSetMenu()
{
   $(datasetMenu).ready(function() {
      console.log("=== datasetMenu ready, now issuing populateDataSetMenu request to server");
      var msg = {cmd: "getDataSetNames",  callback: "handleDataSetNames", status: "request", 
                 payload: ""};
      hub.send(JSON.stringify(msg));
      });

} // populateDataSetMenu
//----------------------------------------------------------------------------------------------------
function handleDataSetNames(msg)
{
   console.log("=== handleDataSetNames");
   
   var dataSetNames = msg.payload.datasets;
   var passwordProtected = msg.payload.passwordProtected;

   if(!Array.isArray(dataSetNames))
      dataSetNames = [dataSetNames];

   for(var i=0; i < dataSetNames.length; i++){
      var s = dataSetNames[i];
      datasetMenu.append("<option value='" + s + "'>" + s + "</option>");
      }

  //if(passwordProtected)
  //   hub.disableButton($("#datasetMenu"));


} // handleDataSetNames
//----------------------------------------------------------------------------------------------------
function requestDataSetSummary(dataSetName)
{
   console.log("=== requestDataSetSummary");

   var msg = {cmd: "getDataManifest",  callback: "displayDataManifest", status: "request", 
              payload: dataSetName};

   hub.send(JSON.stringify(msg));

} // requestDataSetSummary
//----------------------------------------------------------------------------------------------------
function displayDataManifest(msg)
{
   var payload = msg.payload;
   var tblColumnNames = payload.colnames;

   var columnTitles = [];
     // convert simple strings to array of objects, each an sTitle
   for(var i=0; i < tblColumnNames.length; i++){
      columnTitles.push({sTitle: tblColumnNames[i]});
      }
     
   if(typeof(tableRef) != "undefined"){
      tableRef.destroy();
      tableElement.empty();
      }


   $(tableElement).ready(function() {
      tableRef = tableElement.DataTable({
        //sDom: 't',
        aoColumns: columnTitles,
        //scrollX: true,
        bPaginate: false,
        bFilter: false, 
        bAutoWidth: true,
        bSort: false,
        bInfo: false
        }); // dataTable

     tableRef = $("#datasetsManifestTable").DataTable();

     tableRef.rows.add(payload.mtx).draw();
     // tableRef.fnAddData(payload.mtx);

     $('#datasetsManifestTable tbody').on( 'click', 'tr', function (){ 
         console.log("=== click");
         var category = $('td', this).eq(0).text();
         var subcategory = $('td', this).eq(1).text();
         if($(this).hasClass("selected")){
            $(this).removeClass('selected');
            hub.disableButton(sendSelectionsMenu);
            }
         else{
            tableRef.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            hub.enableButton(sendSelectionsMenu);
            console.log("selected " + category + ", " + subcategory);
            }
         });

     handleWindowResize();
     hub.enableButton(useThisDatasetButton);
     postStatus("manifest table displayed");
     }); // tableElement.ready

} // displayDataManifest
//----------------------------------------------------------------------------------------------------
function specifyCurrentDataset()
{
   console.log("Module.datasets 'Use Dataset' button clicked, specifyCurrentDataset: " + selectedDataSet);

   var msg = {cmd: "specifyCurrentDataset",  callback: "datasetSpecified", 
              status: "request", payload: selectedDataSet};

   hub.send(JSON.stringify(msg));

} // specifyCurrentDataset
//----------------------------------------------------------------------------------------------------
function datasetSpecified(msg)
{
   console.log("--- Module.datasets:  datasetSpecified");

} // datasetSpecified
//----------------------------------------------------------------------------------------------------
function test(dataSetName)
{
   console.log("Module.datasets test, on datasetName: '" + dataSetName + "'");

   QUnit.test("choose dataset '" + dataSetName + "'", function(assert) {
      hub.raiseTab("datasetsDiv");
      var desiredDataset = dataSetName;
      var dzNames = $("#datasetMenu option").map(function(opt){return this.value})

      if($.inArray(desiredDataset, dzNames) < 0){
         alert("cannot run tests:  " + desiredDataset + " dataset not loaded");
         return;
         }

      $("#datasetMenu").val(desiredDataset)
      $("#datasetMenu").trigger("change");

      var done1 = assert.async();
      var done2 = assert.async();
      var done3 = assert.async();
      assert.expect(3);

      setTimeout(function(){
         assert.equal($("#datasetMenu").val(), desiredDataset);  done1();
         assert.ok($("#datasetsManifestTable tr").length >= 10); done2();
         assert.equal($("#datasetsManifestTable tbody tr").eq(0).find("td").eq(0).text(), 
                      "mRNA expression"); done3();
         //testLoadPatientHistoryTable();
         }, 5000);
      });


} // test
//----------------------------------------------------------------------------------------------------
function moduleInit()
{

  hub.addOnDocumentReadyFunction(initializeUI);
  // hub.addOnDocumentReadyFunction(function() {$("#datasetsDiv").hide();});
  // hub.registerSelectionDestination(thisModulesName, thisModulesOutermostDiv);
  hub.addSocketConnectedFunction(populateDataSetMenu);
  hub.addMessageHandler("handleDataSetNames", handleDataSetNames);
  hub.addMessageHandler("displayDataManifest", displayDataManifest);
  hub.addMessageHandler("datasetSpecified", datasetSpecified);
  hub.setTitle("Datasets");

} // moduleInit
//----------------------------------------------------------------------------------------------------
return{
   init: moduleInit,
   test: test
   }; // DataSummaryModule return value

//----------------------------------------------------------------------------------------------------
}); // DataSummaryModule

var dataSummaryModule = DataSummaryModule();
dataSummaryModule.init();
hub.registerModule("Datasets", dataSummaryModule);

//----------------------------------------------------------------------------------------------------
var TimeLineModule = (function () {

	// Integration Components
	//--------------------------------------------------------------------------------------------------

    var sendSelectionMenu;
    var sendSelectionsMenuTitle = "Send selection...";
    var selectionDestinationsOfferedHere = ["Timelines"];
    var OneDay = 1000 *60 * 60*24;
	var ThisModuleName = "Timelines";
    var thisModulesOutermostDiv = "patientTimeLinesDiv";

	// Data Elements
	//--------------------------------------------------------------------------------------------------
		var CalculatedEvents =[]//{Name:"Survival", Event1: "Diagnosis", Event2: "Status", TimeScale: "Months"},
//								{Name:"AgeDx",Event1: "DOB", Event2: "Diagnosis", TimeScale: "Years"},
//								{Name:"TimeToProgression",Event1: "Diagnosis", Event2: "Progression", TimeScale: "Days"},
//								{Name:"FirstProgressionToDeath",Event1: "Progression", Event2: "Status", TimeScale: "Days"} ];
//			 CalculatedEvents = d3.nest()
//				  .key(function(d) { return d.Name; })
//				  .map(CalculatedEvents, d3.map);      
		var EventTypes;
		var Events;
		var ptList;
		var ptOrderArray = [];

	// Display features
	//--------------------------------------------------------------------------------------------------
		var TimeLineMargin = {top: 10, right: 15, bottom: 30, left: 25};
        var TimeLineDisplay;
		var svg, SidePlot, TimeLine, legend;
		var MainEvents = ["Birth","Encounter", "Diagnosis", "Procedure","Pathology", "Radiation", "Drug","Progression", "Tests", "Status", "History"];
		var MainEventColors = ["#17becf", "#d62728", "#8c564b","#ff7f0e", "#7f7f7f","#e7969c","#9467bd","#1f77b4","#2ca02c", "#bcbd22","#17becf" ];
        var MainEventTextSpacing = [0, 90, 90, 90, 90, 90, 90, 90, 90, 90, 90];
        var TimeLineColor = d3.scale.ordinal().range(MainEventColors).domain(MainEvents);


//--------------------------------------------------------------------------------------------
     function HandleWindowResize(){
          TimeLineDisplay.width($(window).width() * 0.95);
          TimeLineDisplay.height($(window).height() * 1.05);

         // if(!TimeLineInitialLoad) {dispatch.DisplayPatients();}
     }

//--------------------------------------------------------------------------------------------
     function LogTime(t, TimeScale){ 
        TimeScale = typeof TimeScale !== 'undefined' ? TimeScale : OneDay;
//        if(AlignBy === "--"){ return t;}
//        else{ 
              var Dir = (t<0 ? -1 : 1); 
              return Dir * Math.log(Math.abs(t/TimeScale)+1)/Math.log(2); 
//        }  
     }     

//--------------------------------------------------------------------------------------------------
	function sendSelections()
	{
	  var destination = sendSelectionMenu.val();
	  selectedIDs = identifyEntitiesInCurrentSelection();

	  var cmd = "sendSelectionTo_" + destination;
	  payload = {value: selectedIDs, count: selectedIDs.length, source: "timelines module"};
	  var newMsg = {cmd: cmd,  callback: "", status: "request", payload: payload};

	  sendSelectionMenu.val(sendSelectionsMenuTitle);

	  hub.send(JSON.stringify(newMsg));

	} // sendSelections
//--------------------------------------------------------------------------------------------
	function identifyEntitiesInCurrentSelection ()
	{
	   x1 = currentlySelectedRegion[0][0];
	   y1 = currentlySelectedRegion[0][1];
	   x2 = currentlySelectedRegion[1][0];
	   y2 = currentlySelectedRegion[1][1];
	   ids = [];
			  for(var i=0; i < Events.length; i++){
				  var event = Events[i];
				  if(event.PtNum >= y1 & event.PtNum <= y2){
					 // Patient within range
			
					 if(event.Fields.date.length>1 ){
						if( (LogTime(event.Fields.date[0]-event.offset) >=x1 & LogTime(event.Fields.date[0]-event.offset) <= x2) ||
							(LogTime(event.Fields.date[1]-event.offset) >=x1 & LogTime(event.Fields.date[1]-event.offset) <= x2) ){
						  // date endpoints within range
					
							if(ids.indexOf(event.PatientID) === -1)
							   ids.push(event.PatientID);
						}
					 }else{
						if( LogTime(event.Fields.date-event.offset) >=x1 & LogTime(event.Fields.date-event.offset) <= x2) {
						  // date within range
							if(ids.indexOf(event.PatientID) === -1)
							   ids.push(event.PatientID);
						} //if
					 } //else
				  } //if
			  } // for i
	
			  return (ids);
		 }

//-------------------------------------------------------------------------------------------
// when a dataset is specified, this module 
//  1) extracts the name of the dataset from the payload of the incoming msg
//  2) (for now) extracts the name of the matrices, from the manifest (also in the payload
//     of the incoming msg, chooses the first mtx.mrna entry it finds
//  3) sends a "createPLSR" message to the server, with dataset & matrix name specified
//  4) asks that the server, upon successful completion of that createPLSR request, callback
//     here so that the sliders can be set
	function datasetSpecified(msg)
	{
//	   timelinesXXX = msg;
	   var dataPackageName = msg.payload.datasetName;
 
		   // ["mtx.cn.RData", "history.RData", "mtx.mrna.RData", "mtx.mrna.ueArray.RData", 
		   // "mtx.mut.RData", "mtx.prot.RData", "mtx.meth.RData", "markers.json.RData", 
		   // "genesets.RData", "g.markers.json"]
	   var dataElementNames = msg.payload.rownames;

		  // for now, and very temporarily, use the first match (if any are found)
	   var hits = dataElementNames.map(function(name) {if(name.indexOf("history") >= 0) return(name);});
	   hits = hits.filter(function(n){ return (n !== undefined); });

	   var dataName = null;

	   if(hits.length > 0){
			// for now always grab the first hit, remove the trailing .RData
			// the PLSR constructor wants both dataPacakgeName & a matrix name
			// our convention is that the maniftest rowname is the same as
			// its name, with ".RData" appended
		  dataName = hits[0].replace(".RData", "");
		  }
	   else{
		  return;
		  }
   
	   createTimelinesObjectOnServer(dataPackageName, dataName);

	} // datasetSpecified
//--------------------------------------------------------------------------------------------
	function createTimelinesObjectOnServer(dataPackageName, dataName)
	{
	  console.log("create Timelines on server " + dataPackageName + ": " + dataName);
 
	  payload = {dataPackage: dataPackageName, dataName: dataName};

	  msg = {cmd: "createTimelines", callback: "DisplayPatientTimeLine", status: "request", payload: payload};

	  msg.json = JSON.stringify(msg);
	  hub.send(msg.json);

	} // createTimelinesObjectOnServer

//--------------------------------------------------------------------------------------------------     
     function handlePatientIDs(msg){
  
          hub.raiseTab(thisModulesOutermostDiv);
//          console.log(msg);
          
          if(msg.status == "request"){
             patientIDs = msg.payload.value;
             payload = patientIDs;
             msg = {cmd: "calculateTimelines", callback: "DisplayPatientTimeLine", status: "request", 
                    payload: payload};
             hub.send(JSON.stringify(msg));
          }
          else{
             console.log("handlePatientIDs about to call alert: " + msg);
             alert(msg.payload);
         }
     } // handlePatientIDs


//--------------------------------------------------------------------------------------------
     function initializeUI(){
        console.log("========== initializing Timeline UI");
       	d = new Date();
       	thenDate = d.getTime();
       	d = new Date();
		nowDate = d.getTime();
		console.log(nowDate - thenDate);
		thenDate = nowDate;

		TimeLineDisplay = $("#TimeLineDisplay");
//        HandleWindowResize();
 
        sendSelectionMenu = hub.configureSendSelectionMenu("#timeLineSendSelectionsMenu", 
                                                        selectionDestinationsOfferedHere,
                                                        sendSelections,
                                                        sendSelectionsMenuTitle);  
        $(window).resize(HandleWindowResize);

        $("#AlignByMenu").change(updateDisplayAlignment);
        $("#OrderByMenu").change(updateDisplayOrder);
        $("#SideBarMenu").change(updateDisplaySidePlot);

		initDisplay()

    }

 //--------------------------------------------------------------------------------------------------
     function initDisplay(){

          console.log("======== initDisplay");
                    
          var width = $("#TimeLineDisplay").width();
          var height = $("#TimeLineDisplay").height();
          
          var TimeLineSize ={width: (0.8*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.75*height - TimeLineMargin.top - TimeLineMargin.bottom)},
              SideBarSize = {width: (0.25*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.75*height - TimeLineMargin.top - TimeLineMargin.bottom)},
              legendSize =  {width: TimeLineSize.width, height: 0.25*height};

          svg = d3.select("#TimeLineDisplay").append("svg")
                      .attr("id", "timelineSVG")
                      .attr("width", TimeLineSize.width + 2*SideBarSize.width + 2*TimeLineMargin.left + 2*TimeLineMargin.right )
                      .attr("height", SideBarSize.height + TimeLineMargin.top + TimeLineMargin.bottom + legendSize.height)
                      ;

          SidePlot = svg.append("g").attr("id", "SidePlotSVG")
                            .attr("transform", "translate(" + TimeLineMargin.left + "," + TimeLineMargin.top + ")");     
             
          TimeLine = svg.append("g").attr("id", "TimeLineSVG")
                            .attr("transform", "translate(" + (SideBarSize.width+TimeLineMargin.left + TimeLineMargin.right) + "," + TimeLineMargin.top + ")");
          
          var TextOffSet = d3.scale.ordinal()
                             .range(MainEventTextSpacing)
                             .domain(MainEvents);
                             
          console.log("==== Event Types");
          legend = svg.append("g")
                          .attr("class", "legend")
                          .attr("transform", "translate(" + (SideBarSize.width+2* TimeLineMargin.left + TimeLineMargin.right) + "," + (TimeLineSize.height+ TimeLineMargin.top + TimeLineMargin.bottom) + ")")
//         			      .selectAll(".legend")
//                          .data(TimeLineColor.domain().filter(function(d){
//                                return EventTypes.keys().indexOf(d) !== -1; })  )
//                          .enter().append("g")
//                            .attr("transform", function(d, i) { 
//                                  return "translate(" + i*TextOffSet(d) + ",0)" ;})
                          ;
//          legend.append("rect")
//                .attr("width", 10)
//                .attr("height", 10)
//                .style("fill", function(d) { return TimeLineColor(d);})
//                .on("click", ToggleVisibleEvent);

//          legend.append("text")
//                .attr("y", 9)
//                .attr("x", 12)
//                .style("font-size", "12px")
//                .text(function(d) { return d; });


	}

//--------------------------------------------------------------------------------------------------
     function loadPatientDataDisplay(msg) {
          console.log("==== loadPatientDataDisplay");
//          console.log(msg);
       	d = new Date();
       	thenDate = d.getTime();

          Events = msg.payload.events;
          ptList = msg.payload.pts;
          EventTypes = msg.payload.eventTypes;
          
          console.log("Event count: " + Events.length);
          console.log("Patient count: " + ptList.length);
          console.log("Category count: " + EventTypes.length);
          
          parseDate = d3.time.format ("%m/%d/%Y").parse;
          FormatDate = d3.time.format ("%x");
          
          for( pt in ptList){
        		ptList[pt].showPatient = true;  ptList[pt].PatientHeight=1;  
            	ptList[pt].offset = 0;          ptList[pt].EventOffset=0; 
		  };
		  
		  for(event in EventTypes){		EventTypes[event].disabled = false;		  };
		  

		  loadDataMenus();
//		  initDisplay();
		  plotTimelines();
          
          

}

//--------------------------------------------------------------------------------------------------
	function loadDataMenus(){
			  console.log("======== load.Menu") ;               

		  for(elem in EventTypes){
			   $("#AlignOptions").append(" <option>"+elem+"</option>");
  			   $("#OrderOptions").append(" <option>"+elem+"</option>");
			             
               $("#Event1").append("<option value='"+ elem +"'>"+ elem +"</option>");
               $("#Event2").append("<option value='"+ elem +"'>"+ elem +"</option>");
		  }
		  for(elem in CalculatedEvents){
			   $("#OrderOptions").append(" <option>"+elem+"</option>")
			   $("#SideBarOptions").append(" <option>"+elem+"</option>")
		  }
	  
	}

//--------------------------------------------------------------------------------------------------
        function updateDisplayAlignment(){
			// AlignEvents(); 
			// updateDisplay()
        }
//--------------------------------------------------------------------------------------------------
        function updateDisplayOrder(){
			//  OrderBy = this.value; 
			//			 if(OrderBy === "+Add"){
			//				console.log("== changing OrderBy with ", OrderBy);
			//				OpenDialogForAddedEvents("OrderBy");
			//			 }else{
			//				console.log("== changing OrderBy ", OrderBy);
			//				OrderEvents();      
			//				updateDisplay();
			//			 }        
        }
//--------------------------------------------------------------------------------------------------
        function updateDisplaySidePlot(){
			//	SidePlotEvent = this.value; 
			//	 if(SidePlotEvent === "+Add"){
			//		console.log("== changing SideBar with ", SidePlotEvent);
			//		OpenDialogForAddedEvents("SidePlot");
			//	 } else{ 
			//		console.log("== changing SideBar", SidePlotEvent);
			//		updateDisplay(); 
			//	 }
        
        }

//--------------------------------------------------------------------------------------------------
		function plotTimelines(){

               console.log("======== DisplayPatients.TimeLineDisplay");
               var tooltip = d3.select("body")
                               .attr("data-toggle", "tooltip")
                               .append("div")
                               .style("position", "absolute")
                               .style("z-index", "10")
                               .style("visibility", "hidden")
                               .text("a simple tooltip");

              TimeLineSize = {width: (0.8*width - TimeLineMargin.left - TimeLineMargin.right), height: (0.75*height - TimeLineMargin.top - TimeLineMargin.bottom)};
                var x,TimeScale, xTitle, xAxis, 
                   y = d3.scale.linear().range([TimeLineSize.height, 0]), 
                   yAxis = d3.svg.axis().scale(y).orient("left").ticks(0)
                   ;
            
               if(AlignBy === "--"){ 
                  x = d3.time.scale().range([0, TimeLineSize.width]); TimeScale =1;
                  Xtitle="Year";
                  xAxis = d3.svg.axis().scale(x).orient("bottom");
               } else{
                  x =  d3.scale.linear().range([0, TimeLineSize.width]);
                  TimeScale = OneDay;
                  Xtitle = "Days";
                  xAxis = d3.svg.axis().scale(x).orient("bottom")
                            .ticks(10)
                            .tickFormat(function (d) { 
                               var Dir = (d<0 ? -1 : 1); 
                               return Math.round(Dir * (Math.pow(2, (Math.abs(d)))-1) *100)/100;
                            });
               }

               var EventMin = d3.min(ptList.filter(function(d){return d.showPatient;}), //return d.showPatient && !d.disabled;}), 
                                    	function(d){  d.dateEvents.filter(function(date){!EventTypes[date.name].disabled }), LogTime((d.date[0] - d.offset), TimeScale)
                                    				})
                                                
               var EventMax = d3.max(ptList.filter(function(d){return d.showPatient;}), //return d.showPatient && !d.disabled;}), 
                                    	function(d){  d.dateEvents.filter(function(date){!EventTypes[date.name].disabled }), LogTime((d.date[0] - d.offset), TimeScale)
                                    				});
               x.domain([EventMin, EventMax]);

               TimeLined3PlotBrush = d3.svg.brush()
                                       .x(x).y(y)
                                       .on("brushend", timelineD3PlotBrushReader);

               TimeLine.call(TimeLined3PlotBrush);


               TimeLine.append("g")
                       .attr("class", "x axis")
                       .attr("transform", "translate(0," + TimeLineSize.height + ")")
                       .call(xAxis)
                       .append("text")
                       .style("font-size", "12px")
                       .text(Xtitle);
 
               TimeLine.append("g")
                       .attr("class", "y axis")
                       .call(yAxis)
                       .append("text")
                       .attr("transform", "rotate(-90)")
                       .attr("y", 2)
                       .attr("dy", "-.71em")
                       .style("text-anchor", "end")
                       .style("font-size", "12px")
                       .text("Patients");
      
               var Hoverbar = TimeLine.append("g").attr("class", "hoverbar");
                            
               y.domain([d3.min(ptList,function(d) { return d.PtNum; })-2,
                         d3.max(Events,function(d) { return d.PtNum; })+1]);
               console.log("Timeline" + y.domain());
               var PixelScale = d3.max([d3.min([y(0)-y(1), 20]), 3]);
               console.log(PixelScale);
				// y domain doesn't filter by showPatient or event disabled - showPatient set to false when lacks AlignBy element so has blank row in timeline
 
               var TimeSeries = TimeLine.append("g")
                                        .selectAll("path")
                                        .data(Events.filter(function(d){ 
                                              return (d.Fields.date instanceof Array) && !d.disabled && d.showPatient;}))
               ;

  //            console.log("TimeSeries", TimeSeries)

               TimeSeries.enter()
                    .append("line")
                    .attr("class", "path")
                    .attr("x1", function(d) { return x(LogTime((d.Fields.date[0] - d.offset), TimeScale));        })
                    .attr("x2", function(d) { return x(LogTime((d.Fields.date[1] - d.offset), TimeScale));        })
                    .attr("y1", function(d) { return y(d.PtNum) + PixelScale*(d.EventOffset +1)/(d.PatientHeight +1); })
                    .attr("y2", function(d) { return y(d.PtNum) + PixelScale*(d.EventOffset +1)/(d.PatientHeight +1); })
                    .attr("stroke", function(d){ 
                        if(GreyOutPts.indexOf(d.PatientID) !== -1) return "grey";
                    
                        var ColorShade = d3.rgb(TimeLineColor(d.Name)); 
   //                      if(d3.keys(d).indexOf("Type") !== -1){ 
   //                           return ColorShade.brighter((EventTypes.get(d.Name).indexOf(d.Fields) % 5)/2) };
                        return ColorShade; })
                    .attr("stroke-width", function(d){return PixelScale/d.PatientHeight;})
                    .attr("data-legend",function(d) { return d.Name;})
                    .on("mouseover", function(d,i){
                        Hoverbar.append("rect")
                                .attr("x", 0)
                                .attr("y", function(){return y(d.PtNum);})
                                .attr("width", TimeLineSize.width)
                                .attr("height", function(){return PixelScale;})
                                .style("fill", "grey").style("opacity", 0.3);    
                        var Type = ""; 
                        if(d3.keys(d).indexOf("Type") !== -1){ Type = d.Fields;}
                        tooltip.text(d.PatientID + ": " + d.Name + " (" + FormatDate(d.Fields.date[0]) + ", "+ FormatDate(d.Fields.date[1]) + ") " + Type);
                        return tooltip.style("visibility", "visible");})
                    .on("mousemove", function(){
                        return tooltip.style("top",(d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                    .on("mouseout", function(){
                        Hoverbar.select("rect").remove();
                        return tooltip.style("visibility", "hidden");})
                    ;
               TimeSeries.exit().remove();

               var TimePoint = TimeLine.append("g").selectAll("circle")
                    .data(Events.filter(function(d){ return !(d.Fields.date instanceof Array) && !d.disabled && d.showPatient;}));

               TimePoint.enter()
                        .append("circle")
                        .attr("class", "circle")
                        .style("fill", function(d){ 
                           if(GreyOutPts.indexOf(d.PatientID) !== -1) return "grey";
                           return TimeLineColor(d.Name); })
                        .attr("cx", function(d) { return x(LogTime((d.Fields.date -d.offset), TimeScale)); })
                        .attr("cy", function(d) { return y(d.PtNum)+0.5*PixelScale; })
                        .attr("r", function(d)  { return 0.5*PixelScale;})
                        .attr("data-legend",function(d) { return d.Name;})
                        .on("mouseover", function(d,i){
                            Hoverbar.append("rect")
                                    .attr("x", 0)
                                    .attr("y", function(){return y(d.PtNum);})
                                    .attr("width", TimeLineSize.width)
                                    .attr("height", PixelScale)
                                    .style("fill", "grey").style("opacity", 0.3);
                            var Type = ""; 
                            if(d3.keys(d).indexOf("Type") !== -1){ Type = d.Fields;}
                            tooltip.text(d.PatientID + ": " + d.Name + " (" + FormatDate(d.Fields.date) +") " + Type);
                            return tooltip.style("visibility", "visible");})
                        .on("mousemove", function(){
                            return tooltip.style("top",(d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                        .on("mouseout", function(){ Hoverbar.select("rect").remove();return tooltip.style("visibility", "hidden");})
               ;

               TimePoint.exit().remove();                    

}  

//--------------------------------------------------------------------------------------------------
   
   return{
          init: function(){
                hub.addOnDocumentReadyFunction(initializeUI);
                hub.registerSelectionDestination(selectionDestinationsOfferedHere, thisModulesOutermostDiv);
                hub.addMessageHandler("sendSelectionTo_Timelines", handlePatientIDs);
                hub.addMessageHandler("DisplayPatientTimeLine", loadPatientDataDisplay);
                hub.addMessageHandler("TimelinesHandlePatientIDs", handlePatientIDs);
//                hub.addMessageHandler("FilterTimelinePatients", FilterTimelinePatients);
                hub.addMessageHandler("datasetSpecified", datasetSpecified);
                hub.setTitle("Timelines");
 //               hub.addSocketConnectedFunction(loadPatientDemoData);
          },
     };

}); // TimeLineModule
//----------------------------------------------------------------------------------------------------
PatientTimeLine = TimeLineModule();
PatientTimeLine.init();


</script>

<body>

<div id="oncoscapeTabs">
   <ul>
     <li><a href="#datasetsDiv">Datasets</a></li>
     <li><a href="#patientTimeLinesDiv">Timelines</a></li>
   </ul>

<style>
 
</style>

<div id="datasetsDiv">
  <div id="datasetsStatusDiv" style="display:none"></div>
  <div id="dataSummaryControlsDiv">
     <span id="selectDataSetMenuLabel" style="margin-left: 20px;">Available Datasets</span>
     <select type="button" id="datasetMenu" style="margin: 5px;"><option> </option></select>
     <button id="selectDatasetButton">Use Dataset</button>
     <select type="button" id="datasetsSendSelectionsMenu" style="float:right; margin:15px; display: none"></select>
  </div>

   <div id="dataSetNamesOutputDiv" style="margin: 20px;"></div>

   <div id="dataSummaryOutputDiv" style="margin: 20px;overflow-x:auto">
      <div id="datasetInstructions">Please select a dataset from the above menu.</div>
      <table id="datasetsManifestTable" class="display" cellpadding="0" cellspacing="0" border="1" style="margin:0px; width:auto; display:none"></table>
   </div>
</div>



<div id="patientTimeLinesDiv" >
	<div id="ArrangeDataDiv" class="navbar navbar-default" role="navigation">
	<div class="navbar-collapse collapse navbar-inner">
	
	<div class="nav navbar-nav navbar-form navbar-left">  
	     <span id="SideBarMenu">Features: </span>
	     <select type="button" id="SideBarOptions" style="margin: 5px;">
	     	<option> -- </option>
	     	<option> Add+ </option>
	     </select>
	     <span id="AlignByMenu" >Align By: </span>
	     <select type="button" id="AlignOptions" style="margin: 5px;">
	     	<option> -- </option>
	     </select>
	     <span id="OrderByMenu" >Order By: </span>
	     <select type="button" id="OrderOptions" style="margin: 5px;">
	     	<option> -- </option>
	     	<option> Add+ </option>
	     </select>
    </div>
    <div class="infoDiv nav navbar-nav navbar-form navbar-right">
        <select class="btn btn-primary selectpicker" id="timeLineSendSelectionsMenu" name="SendSelectionToModule">Send Selection to...</select>
       </div>
       
       
       
    </div>
    </div>
    <br>
    <div id="TimeLineDisplay" class="content" style="margin:0 auto" >
      </div>
     
     <div id="AddCalculatedEvent" class="Modal" style="display:none">
     <form>
          <label for="Name">Name: </label>
          <input type="text" id="Name" value="e.g. Survival"><br>
          <label for="Event1">Event 1: </label>
          <select id="Event1"></select><br/>
          <label for="Event2">Event 2: </label>
          <select id="Event2"></select><br/>
          <label for="TimeScale"> Time Scale: </label>
          <select id="TimeScale" value="Days, Months, Years">
        		<option value="Days">Days</option>
        		<option value="Months">Months</option>
        		<option value="Years">Years</option>
          </select>
  	</form>
     </div>
 
</div>


</div>


</body>
</html>
