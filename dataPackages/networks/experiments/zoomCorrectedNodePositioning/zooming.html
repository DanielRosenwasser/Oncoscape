<!DOCTYPE html>
<html>
<head>
<title>zoom-corrected node positioning</title>
<script src="http://oncoscape.sttrcancer.org/oncoscape/js/jquery-2.1.3.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.2.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

<script src="http://oncoscape.sttrcancer.org/oncoscape/js/cytoscape-2.5.0.min.js"></script>

<style>

html, body{
   height: 98%;
   }

body {
  margin: 5px;
  }


#outerDiv {
  display: flex;
  flex-flow: column nowrap;
  //border: 1px solid red;
  }
  

#controlsDiv {
  flex: 1;
  align-self: stretch;
  border: 1px solid #444;
  border-radius:5px;
  background-color: #F8F8F8;
  margin-bottom: 10px;
  -webkit-box-pack: center;
  -moz-box-pack: center;
  -ms-flex-pack: center;
  -webkit-justify-content: center;
  justify-content: center;
  }

.selectMenus{
   float: right;
   font-size: 16px;
   }
   
#cyDiv {
  flex: 1;
  //align-self: stretch;
  border: 1px solid #444;
  border-radius:5px;
  background-color: #F8F8F8;
  -webkit-box-pack: center;
  -moz-box-pack: center;
  -ms-flex-pack: center;
  -webkit-justify-content: center;
  justify-content: center;
  }

.appControlButtons{
   font-size: 16px;
   float:right;
   margin: 10px;
   margin-top: 20px;
   margin-bottom: 20px;
   }

select {
  font-size: 16px;
  }


</style>

<script>

var cy;
var cyDiv;
var controlsDiv;
var initialZoom;
var oldZoom;
var zoomModeMenu;
var zoomMode = "Fixed";
var nodeLabelVisibilityMenu;
var nodeLabelVisibility = "Never";
var resetButton;
//----------------------------------------------------------------------------------------------------
function initializeUI()
{
   cyDiv = $('#cyDiv');
   $(document).tooltip();
   
   controlsDiv = $('#controlsDiv');

   zoomModeMenu = $("#zoomModeMenu");
   zoomModeMenu.change(setZoomMode);

   nodeLabelVisibilityMenu = $("#nodeLabelVisibilityMenu");
   nodeLabelVisibilityMenu.change(setNodeLabelVisibility);
   resetButton = $("#resetButton");

   $(window).resize(handleWindowResize);
   $("#resetButton").click(function(){
      cy.zoom(1);
      cy.fit(50);
      cy.zoom({level: 1.0, renderedPosition:{x:$(window).width()/2, y:$(window).height()/2}});
      cy.nodes().map(function(node){node.style({width: node.data("trueWidth"), height: node.data("trueHeight")})})
      });
      
   createNetwork()
   handleWindowResize();

}  // initializeUI
//--------------------------------------------------------------------------------
function handleWindowResize ()
{
  w = $(window).width() * 0.99;
  h = $(window).height() * 0.97;

  cyDiv.width(w);
  cyDiv.height(h - controlsDiv.height());

  controlsDiv.width(w);

} // handleWindowResize
//--------------------------------------------------------------------------------
function setNodeLabelVisibility()
{
  nodeLabelVisibility = $("#nodeLabelVisibilityMenu option:selected").text();
  console.log("setNodeVisibility: " + nodeLabelVisibility);

  if(nodeLabelVisibility === "Always")
     cy.style().selector('node').style({'label': 'data(id)'}).update()
  else if(nodeLabelVisibility === "Never")
     cy.style().selector('node').style({'label': ''}).update()

} // setZoomMode
//--------------------------------------------------------------------------------
function setZoomMode()
{
  zoomMode = $("#zoomModeMenu option:selected").text();

} // setZoomMode
//--------------------------------------------------------------------------------
function createNetwork()
{
   console.log('starting createNetwork');
   cy = cytoscape({
     container: document.getElementById('cyDiv'), // container to render in
     elements: {
       nodes: [
        {data: {id: 'a', trueWidth: 100, trueHeight: 100}, position: {x:100, y:100}}, 
        {data: {id: 'b', trueWidth: 100, trueHeight: 100}, position: {x:200, y:200}},
        {data: {id: 'c', trueWidth: 100, trueHeight: 100}, position: {x:50,  y:50}}
        ],
      edges: [
        ]},

     style: [
       {selector: 'node',
        style: {
           'border-color': 'gray',
           'borderWidth': 1,
           'text-valign': 'center',
           'text-halign': 'center',
           width: 100,
           height: 100,
           'background-color': '#E8E8E8',
           'label': 'data(id)'
        }},
      {selector: 'node:selected',
         style: {
            'borderWidth': 5
            }},
            
      {selector: 'edge',
        style: {
          'width': 3,
          'line-color': 'red',
          'target-arrow-color': 'red',
          'target-arrow-shape': 'triangle',
          'source-arrow-color': 'red',
          'source-arrow-shape': 'triangle'
         }}],

     layout: {
       name: 'preset'
       },
     ready: function(){
       console.log('cy ready');
       handleWindowResize();
       cy.fit(50);
       cy.zoom({level: 1.0, renderedPosition:{x:$(window).width()/2, y:$(window).height()/2}});
       initialZoom = cy.zoom();
       oldZoom = cy.zoom();
       cy.on('zoom', function(event){
          if(zoomMode === "Spread")
            smartZoom(event);
          });
       } // ready
     });  // cytoscape

} // createNetwork
//----------------------------------------------------------------------------------------------------
function smartZoom(event)
{
   console.log("smartZoom");
   console.log(event);
   var newZoom = 1.0 + cy.zoom() - oldZoom;
   oldZoom = cy.zoom(); // keep this for next time
   console.log("newZoom: " + newZoom);
   var visibleNodes = cy.nodes().fnFilter(function(node){return node.visible()});
   console.log("NEW zoom: " + cy.zoom());
   var sizeFactor = initialZoom/cy.zoom()
   visibleNodes.map(function(node){
      if(sizeFactor < 1.0){
         var newWidth = node.data("trueWidth") * sizeFactor;
         var newHeight = node.data("trueHeight") * sizeFactor;
         console.log("sizeFactor: " + sizeFactor);
         console.log("newWidth: " + newWidth);
         node.style({width: newWidth, height: newHeight});
         } // zoomed in, so make node's mapped size smaller, so that apparent size is unchanged
      }) // 

} // smartZoom
//----------------------------------------------------------------------------------------------------
$(document).ready(initializeUI);
  
</script>

</head>
<body>
  <div  id='outerDiv'>

    <div id='controlsDiv'>

         <select title="Node zooming mode"  id="zoomModeMenu" class="appControlButtons" >
              <option value="fixed">Fixed</option>
              <option value="spread">Spread</option>
         </select>

        <select title="Node label visibility" id="nodeLabelVisibilityMenu" class="appControlButtons">
           <option value="always">Always</option>
           <option value="never">Never</option>
           <option value="onSpread">On spread zoom</option>
        </select>
      <button title="Restore initial layout" id='resetButton' class="appControlButtons">Reset</button>
    </div>

    <div id='cyDiv'></div>
  </div>
</body>
</html>
